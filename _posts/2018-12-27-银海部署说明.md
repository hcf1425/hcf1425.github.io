## 银海部署说明

### 前言

银海所有代码部署在allfun测试服务器上：`/usr/local/siversea/`目录下，对应域名为`allfun.3dnest.biz`。

目录结构：

```
silversea
├── common
└── estate
```

- common —————— 通用主线
- estate ——————对应房地产

### 一、通用主线部署

`/usr/local/siversea/common`通用主线目录结构

```
common
├── nest_manager
├── play_edit
├── play_new
└── play  (play现在beyond.3dnest.cn, 现在不部署)
```

#### 1. 修改nest_manager相关配置

- 注释nest_manager中setting.py文件中的weixinAPIs应用，不然会引起模块导入问题。
- mac 系统上传时记得要在nest_manager/nest_manager/`__init__.py`把导入pymysql语句注释掉。
- 修改nest_manager/nest_manager/nest_manager.ini文件：
  - 修改socket = 127.0.0.1:3070（修改端口号为3070，不能和其他应用端口号冲突。）
  - 修改listen = 100（原来为1024，会报错，改小一点，100 就够了）
  - 修改pidfile为pidfile = /usr/local/silversea/common/nest_manager/uwsgi.pid
  - 修改pythonpath为pythonpath= /usr/local/silversea/common/nest_manager

#### 2. 配置Nginx

- 编辑配置信息

在`/usr/local/3dnest/nginx/conf`找到nginx.conf配置文件进行编辑。(编辑前记得备份！)

找到如下配置，修改相关配置。

```nginx
server {
	listen 80;
        server_name allfun.3dnest.biz;  # 给银海的配置的域名


# ================= silversea nest_manager_common  ===========

	location /home {
            root /usr/local/silversea/common/nest_manager;
            include uwsgi_params;
	    uwsgi_connect_timeout 6000 ;
            uwsgi_read_timeout 6000 ;
            uwsgi_send_timeout 6000 ;
            uwsgi_pass 127.0.0.1:3070;      # uwsgi 运行的端口
        }
```

- 重启Nginx服务使配置生效

```
sudo /usr/local/3dnest/nginx/sbin/nginx -s reload	
```

#### 3. 运行uwsgi程序

将目录切换到`/usr/local/silversea/common`下：

- 启动（初始化）uwsgi程序

```
uwsgi --ini nest_manager/nest_manager.ini
```

- 停止uwsgi程序

```
uwsgi --stop uwsgi.pid
```

- 重新加载（每天更新代码后需要重新加载）

```
uwsgi --reload uwsgi.pid
```

**注意：**初次运行时，一定要先加载 nest_manager.ini

这样通用主线就部署完成了！

### 二、房地产主线部署

`/usr/local/siversea/estate`房地产主线目录结构:

```
estate
├── nest_manager
├── play_edit_utils
├── play_house
├── play_edit_house
└── play_edit_screen
```

#### 1. 修改nest_manager相关配置

- 注释nest_manager中setting.py文件中的weixinAPIs应用，不然会引起模块导入问题。
- mac 系统上传时记得要在nest_manager/nest_manager/`__init__.py`把导入pymysql语句注释掉。
- 修改nest_manager/nest_manager/nest_manager.ini文件：
  - 修改socket = 127.0.0.1:3080（修改端口号为3080，不能和其他应用端口号冲突。）
  - 修改listen = 100（原来为1024，会报错，改小一点，100 就够了）
  - 修改pidfile为pidfile = /usr/local/silversea/estate/nest_manager/uwsgi.pid
  - 修改pythonpath为pythonpath= /usr/local/silversea/estate/nest_manager

#### 2. 配置Nginx

- 编辑配置信息

在`/usr/local/3dnest/nginx/conf`找到nginx.conf配置文件进行编辑。(编辑前记得备份！)

找到如下配置，修改相关配置。

```nginx
server {
	listen 80;
        server_name allfun.3dnest.biz;  # 给银海的配置的域名


# ================= silversea nest_manager_estate  ===========
	location /manager_house {
	    add_header Access-Control-Allow-Origin *;
            root /usr/local/silversea/estate/nest_manager;
            include uwsgi_params;
	    uwsgi_connect_timeout 600 ;
            uwsgi_read_timeout 600 ;
            uwsgi_send_timeout 600 ;
            uwsgi_pass 127.0.0.1:3080; # 修改端口号
        }
```

- 重启Nginx服务使配置生效

```
sudo /usr/local/3dnest/nginx/sbin/nginx -s reload	
```

#### 3. 运行uwsgi程序

将目录切换到`/usr/local/silversea/estate`下：

- 启动（初始化）uwsgi程序

```
uwsgi --ini nest_manager/nest_manager_5j5j.ini
```

**注意：**初次运行时，一定要先加载 nest_manager.ini

这样房地产主线就部署完成了！是不是很简单！！###@@###！！